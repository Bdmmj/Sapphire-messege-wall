<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—¥è®° - ç•™è¨€å¢™</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .diary-container {
            max-width: 80vw;
            /* è§†å£å®½åº¦çš„80% */
            width: 80%;
            margin: 0 auto;
            padding: 20px;
        }

        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .diary-editor {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .diary-title {
            width: 100%;
            padding: 12px;
            border: 2px solid #f598b9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .diary-content {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #f598b9;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
        }

        .save-btn {
            background: #38a169;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }

        .diary-entries {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .diary-entry {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px 0;
        }

        .diary-entry:last-child {
            border-bottom: none;
        }

        .entry-date {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .entry-title {
            font-weight: bold;
            color: #d44d7e;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .entry-content {
            line-height: 1.6;
            color: #333;
        }

        .mood-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mood-option {
            padding: 8px 15px;
            border: 2px solid #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            background: white;
        }

        .mood-option.selected {
            border-color: #d44d7e;
            background: #fff5f7;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="tt">æˆ‘çš„æ—¥è®°</div>
    </div>

    <div class="diary-container">
        <button class="back-btn" onclick="goBack()">â† è¿”å›ç•™è¨€å¢™</button>

        <!-- æ—¥è®°ç¼–è¾‘å™¨ -->
        <div class="diary-editor">
            <h3>å†™æ–°æ—¥è®°</h3>
            <input type="text" class="diary-title" id="diaryTitle" placeholder="æ—¥è®°æ ‡é¢˜...">

            <div class="mood-selector">
                <div class="mood-option" data-mood="happy">ğŸ˜Š å¼€å¿ƒ</div>
                <div class="mood-option" data-mood="normal">ğŸ˜ ä¸€èˆ¬</div>
                <div class="mood-option" data-mood="sad">ğŸ˜” éš¾è¿‡</div>
                <div class="mood-option" data-mood="excited">ğŸ˜† å…´å¥‹</div>
            </div>

            <textarea class="diary-content" id="diaryContent" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."></textarea>
            <button class="save-btn" id="saveDiaryBtn">ä¿å­˜æ—¥è®°</button>
        </div>

        <!-- æ—¥è®°åˆ—è¡¨ -->
        <div class="diary-entries">
            <h3>æˆ‘çš„æ—¥è®°æœ¬</h3>
            <div id="diaryList">
                <!-- æ—¥è®°æ¡ç›®ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <script>
        function goBack() {
            window.location.href = 'index.html';
        }

        let currentMood = 'normal';
        let currentUserId = localStorage.getItem('userId') || generateUserId();

        // ç”Ÿæˆç”¨æˆ·ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const saveBtn = document.getElementById('saveDiaryBtn');
            const diaryTitle = document.getElementById('diaryTitle');
            const diaryContent = document.getElementById('diaryContent');
            const diaryList = document.getElementById('diaryList');
            const moodOptions = document.querySelectorAll('.mood-option');

            // Supabase é…ç½® - æ›¿æ¢æˆä½ çš„é…ç½®
            const SUPABASE_URL = 'https://ä½ çš„é¡¹ç›®.supabase.co';
            const SUPABASE_ANON_KEY = 'ä½ çš„anon key';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // å¿ƒæƒ…é€‰æ‹©
            moodOptions.forEach(option => {
                option.addEventListener('click', function () {
                    moodOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentMood = this.dataset.mood;
                });
            });

            // é»˜è®¤é€‰æ‹©"ä¸€èˆ¬"
            document.querySelector('.mood-option[data-mood="normal"]').classList.add('selected');

            // ä¿å­˜æ—¥è®°
            saveBtn.addEventListener('click', saveDiary);

            // åŠ è½½æ—¥è®°åˆ—è¡¨
            loadDiaries();

            async function saveDiary() {
                const title = diaryTitle.value.trim();
                const content = diaryContent.value.trim();

                if (!title || !content) {
                    alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('diaries')
                        .insert([
                            {
                                user_id: currentUserId,
                                title: title,
                                content: content,
                                mood: currentMood,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;

                    alert('æ—¥è®°ä¿å­˜æˆåŠŸï¼');
                    diaryTitle.value = '';
                    diaryContent.value = '';
                    loadDiaries(); // é‡æ–°åŠ è½½æ—¥è®°åˆ—è¡¨

                } catch (error) {
                    console.error('ä¿å­˜æ—¥è®°å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }

            async function loadDiaries() {
                try {
                    const { data: diaries, error } = await supabase
                        .from('diaries')
                        .select('*')
                        .eq('user_id', currentUserId)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    displayDiaries(diaries);

                } catch (error) {
                    console.error('åŠ è½½æ—¥è®°å¤±è´¥:', error);
                    // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                    diaryList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå†™ä¸€ç¯‡å§ï¼</div>';
                }
            }

            function displayDiaries(diaries) {
                if (!diaries || diaries.length === 0) {
                    diaryList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå†™ä¸€ç¯‡å§ï¼</div>';
                    return;
                }

                diaryList.innerHTML = diaries.map(diary => `
                    <div class="diary-entry">
                        <div class="entry-date">
                            ${new Date(diary.created_at).toLocaleDateString('zh-CN')} 
                            ${getMoodEmoji(diary.mood)}
                        </div>
                        <div class="entry-title">${escapeHtml(diary.title)}</div>
                        <div class="entry-content">${escapeHtml(diary.content)}</div>
                    </div>
                `).join('');
            }

            function getMoodEmoji(mood) {
                const emojis = {
                    'happy': 'ğŸ˜Š',
                    'normal': 'ğŸ˜',
                    'sad': 'ğŸ˜”',
                    'excited': 'ğŸ˜†'
                };
                return emojis[mood] || 'ğŸ“';
            }

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        });
    </script>
</body>

</html>